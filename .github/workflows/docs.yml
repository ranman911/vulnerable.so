name: Documentation Validation

on:
  push:
    paths:
      - '**.md'
      - 'docs/**'
  pull_request:
    paths:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  validate-markdown:
    name: Validate Markdown Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat << 'EOF' > .markdownlint.json
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false
          }
          EOF

      - name: Lint markdown files
        id: markdown-lint
        continue-on-error: true
        run: markdownlint '**/*.md' --ignore node_modules --ignore target

      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/workflows/markdown-link-check-config.json'
        continue-on-error: true

      - name: Validate code blocks
        run: |
          echo "Checking for unclosed code blocks..."
          for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./target/*"); do
            echo "Checking $file"
            # Count opening and closing code fences
            opening=$(grep -c '```' "$file" || true)
            if [ $((opening % 2)) -ne 0 ]; then
              echo "❌ ERROR: Unclosed code block in $file"
              exit 1
            else
              echo "✅ $file: OK"
            fi
          done
          echo "All code blocks are properly closed"

  verify-completeness:
    name: Verify Documentation Completeness
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check all 5 vulnerabilities are documented
        run: |
          echo "Verifying all 5 vulnerabilities are documented..."
          
          vulnerabilities=(
            "01-missing-account-validation"
            "02-incorrect-authority-check"
            "03-unsafe-arithmetic"
            "04-cpi-reentrancy"
            "05-signer-privilege-escalation"
          )
          
          missing=0
          for vuln in "${vulnerabilities[@]}"; do
            if [ -d "examples/$vuln" ]; then
              if [ -f "examples/$vuln/README.md" ]; then
                echo "✅ $vuln: Documented"
              else
                echo "❌ $vuln: Missing README.md"
                missing=$((missing + 1))
              fi
            else
              echo "⚠️ $vuln: Directory not found"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing vulnerabilities are not properly documented"
            exit 1
          fi
          
          echo "All 5 vulnerabilities are properly documented"

      - name: Verify README.md completeness
        run: |
          echo "Checking README.md for required sections..."
          
          required_sections=(
            "## Overview"
            "## Vulnerability Categories"
            "## Repository Structure"
            "## Setup Instructions"
            "## Testing Guide"
            "## Learning Path"
            "## Contribution Guidelines"
            "## Resources"
          )
          
          missing=0
          for section in "${required_sections[@]}"; do
            if grep -q "$section" README.md; then
              echo "✅ Found: $section"
            else
              echo "❌ Missing: $section"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing required sections missing from README.md"
            exit 1
          fi
          
          echo "README.md contains all required sections"

      - name: Check SECURITY.md exists
        run: |
          if [ -f "SECURITY.md" ]; then
            echo "✅ SECURITY.md exists"
            echo "Content preview:"
            head -20 SECURITY.md
          else
            echo "❌ SECURITY.md not found"
            exit 1
          fi

      - name: Verify attack scripts documentation
        run: |
          echo "Checking attack scripts are documented..."
          
          attack_scripts=(
            "01-missing-account-attack"
            "02-incorrect-authority-attack"
            "03-unsafe-arithmetic-attack"
            "04-cpi-reentrancy"
            "05-signer-privilege-attack"
          )
          
          missing=0
          for script in "${attack_scripts[@]}"; do
            if [ -f "scripts/attacks/${script}.ts" ]; then
              echo "✅ Found: scripts/attacks/${script}.ts"
            else
              echo "❌ Missing: scripts/attacks/${script}.ts"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing attack scripts missing"
            exit 1
          fi
          
          echo "All attack scripts are present"

      - name: Check program documentation
        run: |
          echo "Verifying program structure..."
          
          programs=(
            "01a-missing-account-validation-vuln"
            "01b-missing-account-validation-fix"
            "02a-incorrect-authority-vuln"
            "02b-incorrect-authority-fix"
            "03a-unsafe-arithmetic-vuln"
            "03b-unsafe-arithmetic-fix"
            "04a-cpi-reentrancy-vuln"
            "04b-cpi-reentrancy-fix"
            "05a-signer-privilege-escalation-vuln"
            "05b-signer-privilege-escalation-fix"
          )
          
          missing=0
          for program in "${programs[@]}"; do
            if [ -d "programs/$program" ]; then
              echo "✅ Found: programs/$program"
            else
              echo "❌ Missing: programs/$program"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing programs missing"
            exit 1
          fi
          
          echo "All required programs are present"

  generate-documentation-report:
    name: Generate Documentation Report
    needs: [validate-markdown, verify-completeness]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Generate report
        run: |
          cat << 'EOF' > documentation-report.md
          # Documentation Validation Report

          ## Validation Results
          - Markdown Linting: ${{ needs.validate-markdown.result }}
          - Completeness Check: ${{ needs.verify-completeness.result }}

          ## Summary
          All documentation validation checks completed.

          ---
          *Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

          cat documentation-report.md

      - name: Upload report
        uses: actions/upload-artifact@v4.4.3
        with:
          name: documentation-report
          path: documentation-report.md
          retention-days: 30
